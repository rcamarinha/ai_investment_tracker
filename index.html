<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Financial Advisor</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ˆ AI Financial Advisor <span style="font-size: 12px; font-weight: normal; opacity: 0.6;">v3.1.0</span></h1>
            <p>Market analysis and personalized portfolio insights</p>
        </div>

        <div id="authBar" class="auth-bar" style="display: none;"></div>

        <!-- Artifact Network Warning (shown only in artifacts) -->
        <div id="artifactWarning" style="display: none; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
            <div style="display: flex; align-items: start; gap: 10px;">
                <div style="font-size: 24px;">âš ï¸</div>
                <div style="flex: 1;">
                    <div style="font-weight: bold; color: #92400e; margin-bottom: 5px;">Network Restrictions Detected</div>
                    <div style="color: #78350f; font-size: 14px; margin-bottom: 10px;">
                        Claude artifacts cannot fetch live market prices due to network security restrictions.
                    </div>
                    <div style="color: #78350f; font-size: 13px; background: white; padding: 10px; border-radius: 5px; line-height: 1.6;">
                        <strong>ğŸ’¡ Solution: Download & Open Locally</strong><br>
                        â†’ Right-click anywhere on this page<br>
                        â†’ Select "Save As" â†’ Save the HTML file<br>
                        â†’ Open the saved file in your browser<br>
                        âœ“ Full price fetching âœ“ Works offline âœ“ Cloud sync when back in Claude
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="portfolio-header">
                <h2>ğŸ’¼ Your Portfolio</h2>
                <div class="total-value">
                    <div>Total Value</div>
                    <div id="totalValue">$0</div>
                </div>
            </div>

            <div class="positions" id="positions"></div>

            <div>
                <button class="btn btn-key" onclick="showApiKeyDialog()">ğŸ”‘ API Keys</button>
                <button class="btn btn-primary" onclick="showImportDialog()">ğŸ“‹ Import Portfolio from Spreadsheet</button>
                <button class="btn btn-success" onclick="fetchMarketPrices()" id="refreshBtn">ğŸ”„ Update Prices</button>
                <button class="btn btn-warning" onclick="savePortfolioSnapshot()">ğŸ’¾ Save Snapshot</button>
            </div>

            <div id="allocationSection" class="allocation-section" style="display: none;">
                <h3 style="color: #e2e8f0; margin-bottom: 15px;">ğŸ“Š Portfolio Allocation</h3>
                <div class="allocation-charts">
                    <div class="allocation-chart-container">
                        <h4 style="color: #94a3b8; font-size: 12px; text-transform: uppercase; margin-bottom: 10px;">By Asset Type</h4>
                        <div id="typeAllocationChart" class="allocation-chart"></div>
                    </div>
                    <div class="allocation-chart-container">
                        <h4 style="color: #94a3b8; font-size: 12px; text-transform: uppercase; margin-bottom: 10px;">By Sector</h4>
                        <div id="sectorAllocationChart" class="allocation-chart"></div>
                    </div>
                </div>
            </div>

            <div class="perspective-selector" id="perspectiveSelector">
                <div class="perspective-header">
                    <span class="perspective-label">Investment Perspective:</span>
                </div>
                <div class="perspective-tabs" id="perspectiveTabs"></div>
                <div class="perspective-info" id="perspectiveInfo"></div>
                <div class="perspective-buttons">
                    <button class="btn btn-accent" onclick="analyzeMarkets()" id="analyzeBtn">Get AI Analysis</button>
                    <button class="btn btn-trade" onclick="getTradeIdeas()" id="tradeIdeasBtn">ğŸ’¹ Get Trade Ideas</button>
                </div>
            </div>
        </div>

        <div id="apiKeyDialog" style="display: none;">
            <div class="card">
                <h2 style="margin-bottom: 15px;">ğŸ”‘ API Key Management</h2>

                <div style="background: #1e293b; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #cbd5e1; margin-bottom: 10px; font-size: 16px;">3-Tier Strategy:</h3>
                    <div style="color: #94a3b8; font-size: 13px; line-height: 1.8;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>ğŸš€ <strong>Finnhub:</strong> 60 calls/minute (unlimited daily)</span>
                            <span style="color: #4ade80;">PRIMARY</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>âš¡ <strong>FMP:</strong> 250 calls/day (no per-min limit)</span>
                            <span style="color: #60a5fa;">FALLBACK #1</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>ğŸ”„ <strong>Alpha Vantage:</strong> 5 calls/min, 25/day</span>
                            <span style="color: #f59e0b;">FALLBACK #2</span>
                        </div>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: #0f172a; border-radius: 6px; font-size: 12px; color: #94a3b8;">
                        ğŸ’¡ <strong>Strategy:</strong> Finnhub primary (fast), FMP for what it misses (generous limit), Alpha Vantage last resort (strict limits)
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: #cbd5e1; margin-bottom: 8px; font-weight: bold;">ğŸš€ Finnhub API Key (Primary - Fast & Unlimited)</label>
                    <input type="text" id="finnhubKeyInput" placeholder="Enter your Finnhub API key" style="width: 100%; padding: 12px; background: #334155; color: white; border: 1px solid #475569; border-radius: 8px; font-family: monospace; font-size: 13px; margin-bottom: 8px;" />
                    <div style="color: #94a3b8; font-size: 12px;">Get free key: <a href="https://finnhub.io/register" target="_blank" style="color: #60a5fa;">https://finnhub.io/register</a><br>âœ“ 60 calls/minute â€¢ âœ“ Unlimited daily â€¢ âœ“ Best for US stocks</div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: #cbd5e1; margin-bottom: 8px; font-weight: bold;">âš¡ Financial Modeling Prep API Key (Fallback #1 - Generous Limit)</label>
                    <input type="text" id="fmpKeyInput" placeholder="Enter your FMP API key" style="width: 100%; padding: 12px; background: #334155; color: white; border: 1px solid #475569; border-radius: 8px; font-family: monospace; font-size: 13px; margin-bottom: 8px;" />
                    <div style="color: #94a3b8; font-size: 12px;">Get free key: <a href="https://site.financialmodelingprep.com/developer/docs/" target="_blank" style="color: #60a5fa;">https://financialmodelingprep.com</a><br>âœ“ 250 calls/day â€¢ âœ“ Using quote-short endpoint (better free tier support)</div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: #cbd5e1; margin-bottom: 8px; font-weight: bold;">ğŸ”„ Alpha Vantage API Key (Fallback #2 - Last Resort)</label>
                    <input type="text" id="alphaVantageKeyInput" placeholder="Enter your Alpha Vantage API key" style="width: 100%; padding: 12px; background: #334155; color: white; border: 1px solid #475569; border-radius: 8px; font-family: monospace; font-size: 13px; margin-bottom: 8px;" />
                    <div style="color: #94a3b8; font-size: 12px;">Get free key: <a href="https://www.alphavantage.co/support/#api-key" target="_blank" style="color: #60a5fa;">https://www.alphavantage.co/support/#api-key</a><br>âœ“ 5 calls/minute, 25/day â€¢ âœ“ Good international coverage â€¢ âœ“ Use sparingly</div>
                </div>

                <hr style="border: 1px solid #334155; margin: 20px 0;">

                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: #cbd5e1; margin-bottom: 8px; font-weight: bold;">ğŸ¤– Anthropic API Key (AI Analysis)</label>
                    <input type="password" id="anthropicKeyInput" placeholder="Enter your Anthropic API key (sk-ant-...)" style="width: 100%; padding: 12px; background: #334155; color: white; border: 1px solid #475569; border-radius: 8px; font-family: monospace; font-size: 13px; margin-bottom: 8px;" />
                    <div style="color: #94a3b8; font-size: 12px;">Get API key: <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color: #60a5fa;">https://console.anthropic.com/settings/keys</a><br>Required for "Get AI Analysis" when running outside Claude.ai</div>
                </div>

                <hr style="border: 1px solid #334155; margin: 20px 0;">

                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: #cbd5e1; margin-bottom: 8px; font-weight: bold;">â˜ï¸ Supabase Project URL (Cloud Database)</label>
                    <input type="text" id="supabaseUrlInput" placeholder="https://your-project.supabase.co" style="width: 100%; padding: 12px; background: #334155; color: white; border: 1px solid #475569; border-radius: 8px; font-family: monospace; font-size: 13px; margin-bottom: 8px;" />
                    <div style="color: #94a3b8; font-size: 12px;">Get from: <a href="https://supabase.com/dashboard" target="_blank" style="color: #60a5fa;">Supabase Dashboard</a> &gt; Settings &gt; API</div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: #cbd5e1; margin-bottom: 8px; font-weight: bold;">ğŸ”‘ Supabase Anon Key (Public)</label>
                    <input type="text" id="supabaseAnonKeyInput" placeholder="eyJhbGciOiJIUzI1NiIs..." style="width: 100%; padding: 12px; background: #334155; color: white; border: 1px solid #475569; border-radius: 8px; font-family: monospace; font-size: 13px; margin-bottom: 8px;" />
                    <div style="color: #94a3b8; font-size: 12px;">This is the <strong>anon/public</strong> key (safe for browser use). Row Level Security protects your data.</div>
                </div>

                <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                    <div style="color: #92400e; font-size: 13px;">
                        <strong>ğŸ”’ Security:</strong> API keys saved in your browser only (localStorage). Supabase anon key is safe for public use.
                        <br><br>
                        <strong>ğŸ“Š Coverage:</strong> All 3 price APIs combined = ~98%+ success rate. Finnhub ~85%, FMP ~10%, Alpha Vantage ~5%.
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-accent" onclick="saveApiKeys()">ğŸ’¾ Save Keys</button>
                    <button class="btn btn-primary" onclick="closeApiKeyDialog()">Cancel</button>
                    <button class="btn btn-danger" onclick="clearApiKeys()" style="margin-left: auto;">ğŸ—‘ï¸ Clear All Keys</button>
                </div>
            </div>
        </div>

        <div id="importDialog" style="display: none;">
            <div class="card">
                <h2 style="margin-bottom: 15px;">ğŸ“‹ Import Positions</h2>
                <p style="color: #cbd5e1; margin-bottom: 15px;">
                    Paste your positions directly from your spreadsheet - including all columns. The app will automatically extract the Ticker, Units, and Avg Unit Price.
                </p>
                <p style="color: #94a3b8; font-size: 13px; margin-bottom: 10px;">
                    âœ… Just copy your entire spreadsheet rows and paste them here!<br>
                    âœ… Works with Excel, Google Sheets, Numbers<br>
                    âœ… Header row is automatically detected and skipped
                </p>
                <textarea id="importText" placeholder="Paste your spreadsheet data here (with or without headers)..." style="width: 100%; height: 200px; padding: 15px; background: #334155; color: white; border: 1px solid #475569; border-radius: 8px; font-family: monospace; font-size: 12px; margin-bottom: 15px;"></textarea>
                <div>
                    <button class="btn btn-accent" onclick="importPositions()">Import Positions</button>
                    <button class="btn btn-primary" onclick="closeImportDialog()">Cancel</button>
                </div>
            </div>
        </div>

        <div id="analysisSection"></div>

        <div id="historySection" style="display: none;">
            <div class="card">
                <h2 style="margin-bottom: 15px;">ğŸ“ˆ Portfolio History</h2>
                <div id="historyChart" style="margin-bottom: 20px;"></div>
                <div id="historyLog"></div>
            </div>
        </div>
    </div>

    <!--
        NOTE: This app uses ES modules. It must be served via HTTP (not file://).
        Use any local server:  python -m http.server 8000
        Or deploy to GitHub Pages / any static host.
    -->
    <script type="module">
        // â”€â”€ Import all modules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        import state from './services/state.js';
        import { isArtifact } from './services/utils.js';
        import { loadSectorCache } from './data/sectors.js';
        import { renderPerspectiveTabs, selectPerspective, toggleSectorFilter,
                 showApiKeyDialog, closeApiKeyDialog, saveApiKeys, clearApiKeys } from './services/ui.js';
        import { renderPortfolio, showImportDialog, closeImportDialog,
                 importPositions, savePortfolioSnapshot, updateHistoryDisplay,
                 clearHistory } from './services/portfolio.js';
        import { fetchMarketPrices } from './services/pricing.js';
        import { analyzeMarkets, getTradeIdeas } from './services/analysis.js';
        import { initSupabase } from './services/storage.js';
        import { handleLogin, handleSignup, handleLogout } from './services/auth.js';

        // â”€â”€ Expose functions to onclick handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.showApiKeyDialog    = showApiKeyDialog;
        window.closeApiKeyDialog   = closeApiKeyDialog;
        window.saveApiKeys         = saveApiKeys;
        window.clearApiKeys        = clearApiKeys;
        window.showImportDialog    = showImportDialog;
        window.closeImportDialog   = closeImportDialog;
        window.importPositions     = importPositions;
        window.fetchMarketPrices   = fetchMarketPrices;
        window.savePortfolioSnapshot = savePortfolioSnapshot;
        window.analyzeMarkets      = analyzeMarkets;
        window.getTradeIdeas       = getTradeIdeas;
        window.selectPerspective   = selectPerspective;
        window.toggleSectorFilter  = toggleSectorFilter;
        window.handleLogin         = handleLogin;
        window.handleSignup        = handleSignup;
        window.handleLogout        = handleLogout;
        window.clearHistory        = clearHistory;

        // â”€â”€ Initialization â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        console.log('=== APP INITIALIZING (modular) ===');

        // Load portfolio history from localStorage
        const storedHistory = localStorage.getItem('portfolioHistory');
        if (storedHistory) {
            try {
                state.portfolioHistory = JSON.parse(storedHistory);
                console.log('Loaded portfolio history:', state.portfolioHistory.length, 'snapshots');
                updateHistoryDisplay();
            } catch (err) {
                console.error('Error loading history:', err);
            }
        }

        // Load from Claude cloud storage (if available)
        if (typeof window.storage !== 'undefined') {
            try {
                console.log('â˜ï¸ Cloud storage available, loading portfolio...');
                const portfolioData = await window.storage.get('current-portfolio', false);
                if (portfolioData && portfolioData.value) {
                    const data = JSON.parse(portfolioData.value);
                    if (data.portfolio && data.portfolio.length > 0) {
                        state.portfolio = data.portfolio;
                        state.marketPrices = data.marketPrices || {};
                        state.priceMetadata = data.priceMetadata || {};
                        console.log('âœ“ Loaded portfolio from cloud:', state.portfolio.length, 'positions');
                        renderPortfolio();
                    }
                }

                const snapshotKeys = await window.storage.list('snapshot:', false);
                if (snapshotKeys && snapshotKeys.keys && snapshotKeys.keys.length > 0) {
                    const existingTimestamps = new Set(state.portfolioHistory.map(s => s.timestamp));
                    for (const key of snapshotKeys.keys) {
                        try {
                            const result = await window.storage.get(key, false);
                            if (result && result.value) {
                                const snapshot = JSON.parse(result.value);
                                if (!existingTimestamps.has(snapshot.timestamp)) {
                                    state.portfolioHistory.push(snapshot);
                                }
                            }
                        } catch (err) {
                            console.warn('Failed to load snapshot:', key, err);
                        }
                    }
                    state.portfolioHistory.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    updateHistoryDisplay();
                }

                alert(`â˜ï¸ Cloud storage loaded!\n\n${state.portfolio.length} positions\n${state.portfolioHistory.length} historical snapshots`);
            } catch (err) {
                console.warn('Cloud storage not available:', err);
            }
        }

        // Load API keys from localStorage
        const storedAVKey = localStorage.getItem('alphaVantageKey');
        if (storedAVKey) state.alphaVantageKey = storedAVKey;
        const storedFHKey = localStorage.getItem('finnhubKey');
        if (storedFHKey) state.finnhubKey = storedFHKey;
        const storedFMPKey = localStorage.getItem('fmpKey');
        if (storedFMPKey) state.fmpKey = storedFMPKey;
        const storedAntKey = localStorage.getItem('anthropicKey');
        if (storedAntKey) state.anthropicKey = storedAntKey;

        console.log('âœ“ API keys ready');

        // Load sector cache
        loadSectorCache();

        // Load Supabase config overrides
        const storedSBUrl = localStorage.getItem('supabaseUrl');
        const storedSBKey = localStorage.getItem('supabaseAnonKey');
        if (storedSBUrl && storedSBKey) {
            state.supabaseUrl = storedSBUrl;
            state.supabaseAnonKey = storedSBKey;
        }
        initSupabase();

        // Render initial UI
        renderPortfolio();
        renderPerspectiveTabs();

        // Show artifact warning if detected
        if (isArtifact) {
            const warningDiv = document.getElementById('artifactWarning');
            if (warningDiv) warningDiv.style.display = 'block';
        }

        // Auto-fetch prices if portfolio exists and API keys available
        if (state.portfolio.length > 0 && (state.finnhubKey || state.fmpKey || state.alphaVantageKey)) {
            console.log('Auto-fetching prices on page load...');
            setTimeout(() => fetchMarketPrices(), 1000);
        }

        // Global error handlers
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('=== GLOBAL ERROR ===', message, source, lineno, colno, error);
            if (message && message !== 'Script error.') {
                alert('JavaScript Error:\n\n' + message + '\n\nLine: ' + lineno);
            }
            return true;
        };

        window.onunhandledrejection = function(event) {
            console.error('=== UNHANDLED REJECTION ===', event.reason);
            alert('Async Error:\n\n' + (event.reason || 'Unknown error'));
        };

        console.log('=== APP INITIALIZED ===');
        console.log('API Keys:', { finnhub: !!state.finnhubKey, fmp: !!state.fmpKey, alphaVantage: !!state.alphaVantageKey, anthropic: !!state.anthropicKey });
        console.log('Portfolio positions:', state.portfolio.length);
        console.log('History snapshots:', state.portfolioHistory.length);
    </script>
</body>
</html>
